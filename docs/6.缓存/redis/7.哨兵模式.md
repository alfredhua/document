
## 哨兵模式

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。

![image](http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/f8c6d8463a3b46b496fb437192f517e9)

这里的哨兵有两个作用

- 通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器。
- 当哨兵监测到master宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机。
  

然而一个哨兵进程对Redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。

用文字描述一下故障切换（failover）的过程。

假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为主观下线。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为客观下线。这样对于客户端而言，一切都是透明的。



## 故障转移

总结来说，故障转移分为三个步骤：

1. 从下线的主服务的所有从服务里面挑选一个从服务，将其转成主服务

   sentinel状态数据结构中保存了主服务的所有从服务信息，领头sentinel按照如下的规则从从服务列表中挑选出新的主服务；
   删除列表中处于下线状态的从服务；删除最近5秒没有回复过领头sentinel info信息的从服务；
   删除与已下线的主服务断开连接时间超过 down-after-milliseconds*10毫秒的从服务，
   这样就能保留从的数据比较新（没有过早的与主断开连接）；
   领头sentinel从剩下的从列表中选择优先级高的，如果优先级一样，选择偏移量最大的（偏移量大说明复制的数据比较新），
   如果偏移量一样，选择运行id最小的从服务。

2. 已下线主服务的所有从服务改为复制新的主服务
   挑选出新的主服务之后，领头sentinel 向原主服务的从服务发送 slaveof 新主服务 的命令，复制新master。

3. 将已下线的主服务设置成新的主服务的从服务，当其恢复正常时，复制新的主服务，变成新的主服务的从服务
   同理，当已下线的服务重新上线时，sentinel会向其发送slaveof命令，让其成为新主的从。
   