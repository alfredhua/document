1. mybatis的核心模块

![image](http://java-run-blog.oss-cn-zhangjiakou.aliyuncs.com/file/5c79a65f3dc24481b8dff7b3a797493a)

2. 注解注入方式（入口）

```java
    @Bean(name = "dataSource")
    public DataSource dataSource() {
        System.out.println("==============  url  " +  url );

        if (maxpoolsize < 10) {
            maxpoolsize = 10;
        }
        if (maxpoolsize > 100) {
            maxpoolsize = 100;
        }
        final HikariDataSource ds = new HikariDataSource();
        ds.setMaximumPoolSize(maxpoolsize);
        ds.setDriverClassName(driverClassName);
        ds.setJdbcUrl(url);
        ds.setUsername(username);
        ds.setPassword(password);
        return ds;
    }

   @Bean
    public SqlSessionFactory sqlSessionFactory(@Qualifier("dataSource") DataSource dataSource) throws Exception {
        org.apache.ibatis.logging.LogFactory.useStdOutLogging();
        final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();
        sessionFactory.setDataSource(dataSource);
        return sessionFactory.getObject();
    }

```

关键在于：
```java
final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();
sessionFactory.setDataSource(dataSource);
return sessionFactory.getObject();
```

sessionFactory.setDataSource(dataSource);
是在进行数据库配置项初始化。

sessionFactory.getObject();

在mybatis-spring.jar中存在SqlSessionFactoryBean。

```java
  public SqlSessionFactory getObject() throws Exception {
    if (this.sqlSessionFactory == null) {
      afterPropertiesSet();
    }

    return this.sqlSessionFactory;
  }

   public void afterPropertiesSet() throws Exception {
    notNull(dataSource, "Property 'dataSource' is required");
    notNull(sqlSessionFactoryBuilder, "Property 'sqlSessionFactoryBuilder' is required");

    this.sqlSessionFactory = buildSqlSessionFactory();
  }
```

getObject()中的afterPropertiesSet方法调用buildSqlSessionFactory()才是进行mybatis的初始化。

mybatis的真正的入口
```java
sqlSessionFactoryBuilder.build(configuration);
```


```java
  public SqlSessionFactory build(Configuration config) {
    return new DefaultSqlSessionFactory(config);
  }
```

加载config配置文件：这里给注入到DefaultSqlSessionFactory的config， openSession的时候config才会有值

```java

```